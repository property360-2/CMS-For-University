<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit {{ website.title }} - SlideSite Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; background: #0f0f0f; color: #fff; }
        
        .editor-container { display: flex; height: 100vh; }
        .sidebar-left { width: 280px; background: #1a1a1a; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; overflow-y: auto; }
        .canvas-area { flex: 1; background: #0f0f0f; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-right { width: 350px; background: #1a1a1a; border-left: 1px solid #2a2a2a; overflow-y: auto; }
        
        .toolbar { background: #1a1a1a; border-bottom: 1px solid #2a2a2a; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
        .toolbar h1 { font-size: 18px; margin: 0; font-weight: 600; }
        .toolbar-actions { display: flex; gap: 8px; }
        
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-secondary { background: #2a2a2a; color: white; }
        .btn-secondary:hover { background: #3a3a3a; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .page-list { padding: 16px; }
        .page-thumb { background: #0f0f0f; border: 2px solid #2a2a2a; border-radius: 8px; padding: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .page-thumb:hover { border-color: #3b82f6; transform: translateX(4px); }
        .page-thumb.active { border-color: #3b82f6; background: #1a2a3a; }
        .page-thumb-preview { aspect-ratio: 16/9; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        
        .canvas { flex: 1; padding: 40px; display: flex; justify-content: center; align-items: flex-start; }
        .canvas-inner { width: 100%; max-width: 1200px; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); min-height: 600px; color: #000; overflow: hidden; }
        
        .section-wrapper { position: relative; transition: all 0.2s; }
        .section-wrapper:hover { outline: 2px dashed #3b82f6; outline-offset: 4px; }
        .section-wrapper:hover .section-controls { opacity: 1; }
        
        .section-controls { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .section-controls button { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px; }
        .section-controls button:hover { background: #f3f4f6; }
        
        .properties { padding: 20px; }
        .property-group { margin-bottom: 24px; }
        .property-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #9ca3af; margin-bottom: 8px; }
        .property-input { width: 100%; padding: 10px 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 6px; color: white; font-size: 14px; }
        .property-input:focus { outline: none; border-color: #3b82f6; }
        textarea.property-input { min-height: 80px; resize: vertical; font-family: monospace; font-size: 12px; }
        
        .color-input { width: 100%; height: 40px; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer; }
        
        .template-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-height: 400px; overflow-y: auto; }
        .template-card { background: #0f0f0f; border: 2px solid #2a2a2a; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .template-card:hover { border-color: #3b82f6; transform: scale(1.02); }
        .template-icon { font-size: 32px; margin-bottom: 8px; }
        .template-name { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .template-desc { font-size: 11px; color: #9ca3af; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a1a; border-radius: 16px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }
        
        .font-picker { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .font-option { background: #0f0f0f; border: 2px solid #2a2a2a; border-radius: 6px; padding: 12px; cursor: pointer; text-align: center; }
        .font-option:hover { border-color: #3b82f6; }
        .font-option.active { border-color: #3b82f6; background: #1a2a3a; }
    </style>
</head>
<body>
    <div class="editor-container">
        
        <!-- Left Sidebar: Pages -->
        <div class="sidebar-left">
            <div style="padding: 20px; border-bottom: 1px solid #2a2a2a;">
                <h2 style="margin: 0 0 16px 0; font-size: 14px; color: #9ca3af; font-weight: 600;">üìÑ PAGES</h2>
                <button class="btn btn-primary" style="width: 100%;" onclick="addPage()">+ Add New Page</button>
            </div>
            
            <div class="page-list" id="pageList">
                {% for page in pages %}
                <div class="page-thumb {% if forloop.first %}active{% endif %}" data-page-id="{{ page.id }}" onclick="selectPage('{{ page.id }}')">
                    <div class="page-thumb-preview">{{ page.title|slice:":1" }}</div>
                    <div style="font-weight: 500; font-size: 14px; margin-bottom: 4px;">{{ page.title }}</div>
                    <div style="font-size: 12px; color: #9ca3af;">{{ page.sections.count }} sections</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Center: Canvas -->
        <div class="canvas-area">
            <!-- Toolbar -->
            <div class="toolbar">
                <h1>‚úèÔ∏è {{ website.title }}</h1>
                <div class="toolbar-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='/dashboard/'">‚Üê Back</button>
                    <button class="btn btn-secondary" onclick="openTemplateModal()">+ Add Section</button>
                    <button class="btn btn-secondary" onclick="previewSite()">üëÅÔ∏è Preview</button>
                    <button class="btn btn-success" onclick="publishSite()">üöÄ Publish</button>
                </div>
            </div>
            
            <!-- Canvas -->
            <div class="canvas">
                <div class="canvas-inner" id="canvas">
                    {% if pages %}
                    {% with page=pages.0 %}
                        {% for section in page.sections.all %}
                        <div class="section-wrapper" data-section-id="{{ section.id }}">
                            <div class="section-controls">
                                <button onclick="editSection('{{ section.id }}')">‚öôÔ∏è Edit</button>
                                <button onclick="moveUp('{{ section.id }}')">‚¨ÜÔ∏è</button>
                                <button onclick="moveDown('{{ section.id }}')">‚¨áÔ∏è</button>
                                <button onclick="deleteSection('{{ section.id }}')">üóëÔ∏è</button>
                            </div>
                            <div class="section-content" style="{% if section.background_color %}background-color: {{ section.background_color }};{% endif %}{% if section.background_gradient %}background: {{ section.background_gradient }};{% endif %}{% if section.text_color %}color: {{ section.text_color }};{% endif %}padding: {{ section.padding|default:'60px 40px' }}; margin: {{ section.margin|default:'0' }}; border-radius: {{ section.border_radius|default:'0' }};">
                                {{ section.body|safe }}
                            </div>
                        </div>
                        {% endfor %}
                    {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar: Properties -->
        <div class="sidebar-right">
            <div class="properties">
                <h2 style="margin: 0 0 24px 0; font-size: 14px; color: #9ca3af; font-weight: 600;">‚öôÔ∏è PROPERTIES</h2>
                
                <div id="sectionProperties" style="display: none;">
                    <!-- Section styling controls go here -->
                    <div class="property-group">
                        <div class="property-label">Background Color</div>
                        <input type="color" class="color-input" id="bgColor" onchange="updateSectionStyle('background_color', this.value)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Text Color</div>
                        <input type="color" class="color-input" id="textColor" onchange="updateSectionStyle('text_color', this.value)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Font Family</div>
                        <div class="font-picker">
                            <div class="font-option" onclick="updateSectionStyle('font_family', 'Arial, sans-serif')" style="font-family: Arial, sans-serif;">Arial</div>
                            <div class="font-option" onclick="updateSectionStyle('font_family', 'Georgia, serif')" style="font-family: Georgia, serif;">Georgia</div>
                            <div class="font-option" onclick="updateSectionStyle('font_family', 'Courier, monospace')" style="font-family: Courier, monospace;">Courier</div>
                            <div class="font-option" onclick="updateSectionStyle('font_family', 'Verdana, sans-serif')" style="font-family: Verdana, sans-serif;">Verdana</div>
                        </div>
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Button Text</div>
                        <input type="text" class="property-input" id="buttonText" placeholder="Get Started" onchange="updateSectionStyle('button_text', this.value)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Button Link</div>
                        <input type="url" class="property-input" id="buttonLink" placeholder="https://..." onchange="updateSectionStyle('button_link', this.value)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Button Color</div>
                        <input type="color" class="color-input" id="buttonColor" onchange="updateSectionStyle('button_color', this.value)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Upload Image</div>
                        <input type="file" class="property-input" accept="image/*" onchange="uploadSectionImage(this)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">Background Image</div>
                        <input type="file" class="property-input" accept="image/*" onchange="uploadBackgroundImage(this)">
                    </div>
                    
                    <div class="property-group">
                        <div class="property-label">HTML Content</div>
                        <textarea class="property-input" id="htmlContent" placeholder="<h1>Edit HTML...</h1>" onchange="updateSectionStyle('body', this.value)"></textarea>
                    </div>
                </div>
                
                <!-- Website Settings -->
                <div class="property-group">
                    <div class="property-label">Website Theme</div>
                    <select class="property-input" onchange="updateWebsite('theme', this.value)">
                        <option value="light" {% if website.theme == 'light' %}selected{% endif %}>‚òÄÔ∏è Light</option>
                        <option value="dark" {% if website.theme == 'dark' %}selected{% endif %}>üåô Dark</option>
                        <option value="purple" {% if website.theme == 'purple' %}selected{% endif %}>üíú Purple</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Template Picker Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 20px;">Choose a Section Template</h2>
                <button class="modal-close" onclick="closeTemplateModal()">√ó</button>
            </div>
            <div class="template-grid">
                {% load static %}
                <div class="template-card" onclick="addSectionFromTemplate('hero')">
                    <div class="template-icon">üöÄ</div>
                    <div class="template-name">Hero Section</div>
                    <div class="template-desc">Large header with CTA</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('two_column')">
                    <div class="template-icon">üì±</div>
                    <div class="template-name">Two Column</div>
                    <div class="template-desc">Text + Image</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('three_features')">
                    <div class="template-icon">‚ö°</div>
                    <div class="template-name">Feature Cards</div>
                    <div class="template-desc">Three feature boxes</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('testimonial')">
                    <div class="template-icon">üí¨</div>
                    <div class="template-name">Testimonial</div>
                    <div class="template-desc">Customer review</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('cta')">
                    <div class="template-icon">üì¢</div>
                    <div class="template-name">Call-to-Action</div>
                    <div class="template-desc">Centered CTA</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('stats')">
                    <div class="template-icon">üìä</div>
                    <div class="template-name">Statistics</div>
                    <div class="template-desc">Show numbers</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('image_gallery')">
                    <div class="template-icon">üñºÔ∏è</div>
                    <div class="template-name">Gallery</div>
                    <div class="template-desc">Image grid</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('faq')">
                    <div class="template-icon">‚ùì</div>
                    <div class="template-name">FAQ</div>
                    <div class="template-desc">Questions & answers</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('pricing')">
                    <div class="template-icon">üí∞</div>
                    <div class="template-name">Pricing Table</div>
                    <div class="template-desc">Price comparison</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('contact_form')">
                    <div class="template-icon">üìß</div>
                    <div class="template-name">Contact Form</div>
                    <div class="template-desc">Get in touch</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('team')">
                    <div class="template-icon">üë•</div>
                    <div class="template-name">Team</div>
                    <div class="template-desc">Team members</div>
                </div>
                <div class="template-card" onclick="addSectionFromTemplate('video')">
                    <div class="template-icon">üé¨</div>
                    <div class="template-name">Video</div>
                    <div class="template-desc">Video embed</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const websiteId = '{{ website.id }}';
        let currentPageId = '{{ pages.0.id }}';
        let selectedSectionId = null;
        
        // Modal functions
        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }
        
        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }
        
        // Add section from template
        function addSectionFromTemplate(templateType) {
            fetch(`/websites/pages/${currentPageId}/sections/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ template_type: templateType })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Section added! ‚úÖ');
                    closeTemplateModal();
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(err => {
                showToast('Error adding section ‚ùå', 'error');
            });
        }
        
        // Edit section
        function editSection(sectionId) {
            selectedSectionId = sectionId;
            document.getElementById('sectionProperties').style.display = 'block';
            
            // Highlight selected section
            document.querySelectorAll('.section-wrapper').forEach(s => {
                s.style.outline = '';
            });
            document.querySelector(`[data-section-id="${sectionId}"]`).style.outline = '3px solid #3b82f6';
            
            showToast('Section selected - Edit in properties panel ‚û°Ô∏è');
        }
        
        // Update section style
        function updateSectionStyle(field, value) {
            if (!selectedSectionId) {
                showToast('Please select a section first', 'error');
                return;
            }
            
            fetch(`/websites/sections/${selectedSectionId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Updated! ‚úÖ');
                    
                    // Update preview
                    const section = document.querySelector(`[data-section-id="${selectedSectionId}"] .section-content`);
                    if (field === 'background_color') {
                        section.style.backgroundColor = value;
                    } else if (field === 'text_color') {
                        section.style.color = value;
                    } else if (field === 'body') {
                        section.innerHTML = value;
                    }
                }
            });
        }
        
        // Upload section image
        function uploadSectionImage(input) {
            if (!selectedSectionId) {
                showToast('Please select a section first', 'error');
                return;
            }
            
            if (!input.files[0]) return;
            
            const formData = new FormData();
            formData.append('image', input.files[0]);
            
            fetch(`/websites/sections/${selectedSectionId}/upload-image/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Image uploaded! ‚úÖ');
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(err => {
                showToast('Upload failed ‚ùå', 'error');
            });
        }
        
        // Upload background image
        function uploadBackgroundImage(input) {
            if (!selectedSectionId) {
                showToast('Please select a section first', 'error');
                return;
            }
            
            if (!input.files[0]) return;
            
            const formData = new FormData();
            formData.append('background', input.files[0]);
            
            fetch(`/websites/sections/${selectedSectionId}/upload-background/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Background uploaded! ‚úÖ');
                    const section = document.querySelector(`[data-section-id="${selectedSectionId}"] .section-content`);
                    section.style.backgroundImage = `url(${data.background_url})`;
                    section.style.backgroundSize = 'cover';
                    section.style.backgroundPosition = 'center';
                }
            })
            .catch(err => {
                showToast('Upload failed ‚ùå', 'error');
            });
        }
        
        // Move section up
        function moveUp(sectionId) {
            // Implementation for reordering
            showToast('Moving up... (implement reorder logic)');
        }
        
        // Move section down
        function moveDown(sectionId) {
            // Implementation for reordering
            showToast('Moving down... (implement reorder logic)');
        }
        
        // Delete section
        function deleteSection(sectionId) {
            if (!confirm('Delete this section?')) return;
            
            fetch(`/websites/sections/${sectionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Section deleted! ‚úÖ');
                    document.querySelector(`[data-section-id="${sectionId}"]`).remove();
                }
            });
        }
        
        // Update website
        function updateWebsite(field, value) {
            fetch(`/websites/${websiteId}/save/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Website updated! ‚úÖ');
                    if (field === 'theme') {
                        setTimeout(() => location.reload(), 500);
                    }
                }
            });
        }
        
        // Add page
        function addPage() {
            const title = prompt('Enter page title:', 'New Page');
            if (!title) return;
            
            fetch(`/websites/${websiteId}/pages/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ title })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Page created! ‚úÖ');
                    location.reload();
                }
            });
        }
        
        // Select page
        function selectPage(pageId) {
            currentPageId = pageId;
            location.reload();
        }
        
        // Publish site
        function publishSite() {
            if (confirm('Publish this website? It will be publicly visible.')) {
                fetch(`/websites/${websiteId}/publish/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                })
                .then(() => {
                    showToast('Published! üöÄ');
                    setTimeout(() => location.reload(), 1000);
                });
            }
        }
        
        // Preview site
        function previewSite() {
            window.open('{{ website.get_absolute_url }}', '_blank');
        }
        
        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'error') {
                toast.style.background = '#ef4444';
            }
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Get CSRF token
        function getCookie(name) {
            let value = `; ${document.cookie}`;
            let parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    showToast('Auto-save enabled! ‚úÖ');
                }
                if (e.key === 'n') {
                    e.preventDefault();
                    addPage();
                }
            }
            
            // ESC to deselect
            if (e.key === 'Escape') {
                selectedSectionId = null;
                document.querySelectorAll('.section-wrapper').forEach(s => {
                    s.style.outline = '';
                });
                document.getElementById('sectionProperties').style.display = 'none';
            }
        });
        
        // Click outside modal to close
        document.getElementById('templateModal').addEventListener('click', (e) => {
            if (e.target.id === 'templateModal') {
                closeTemplateModal();
            }
        });
    </script>
</body>
</html>